name: Update Packages

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.set-matrix.outputs.packages }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          # Find directories in packages/ that contain update.sh
          PACKAGES=$(find packages -mindepth 1 -maxdepth 1 -type d -exec test -e '{}/update.sh' \; -print | sed 's|packages/||' | jq -R -s -c 'split("\n")[:-1]')
          echo "Found packages with update scripts: $PACKAGES"
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

  update:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.packages != '[]' && needs.discover.outputs.packages != ''
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover.outputs.packages) }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate App Token
        id: generate_token
        uses: peter-murray/workflow-application-token-action@v4
        with:
          application_id: ${{ secrets.APP_ID }}
          application_private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Install Dependencies
        run: |
          nix profile install nixpkgs#gh nixpkgs#jq nixpkgs#gnused nixpkgs#curl nixpkgs#nix-prefetch-github
          echo "$HOME/.nix-profile/bin" >> $GITHUB_PATH

      - name: Update ${{ matrix.package }}
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          echo "Running update script for ${{ matrix.package }}"
          # Authenticate gh
          echo "$GITHUB_TOKEN" | gh auth login --with-token
          
          cd packages/${{ matrix.package }}
          # Run the update script from the flake root context might be better, but the scripts are designed to be run from root or handle relative paths?
          # My scripts use relative paths like 'packages/thorium/default.nix' assuming run from root.
          # So I should NOT cd into the directory, but run it from root.
          cd ../..
          chmod +x packages/${{ matrix.package }}/update.sh
          ./packages/${{ matrix.package }}/update.sh

      - name: Configure Git
        if: env.UPDATE_DETECTED == 'true'
        run: |
          git config --global user.email "flakebuilderapp[bot]@users.noreply.github.com"
          git config --global user.name "flakebuilderapp[bot]"

      - name: Create Pull Request
        if: env.UPDATE_DETECTED == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.generate_token.outputs.token }}
          author: "flakebuilderapp[bot] <flakebuilderapp[bot]@users.noreply.github.com>"
          committer: "flakebuilderapp[bot] <flakebuilderapp[bot]@users.noreply.github.com>"
          labels: automated, ${{ matrix.package }}
          delete-branch: true
          commit-message: "feat: Update ${{ matrix.package }} to ${{ env.LATEST_VERSION }}"
          title: "feat: Update ${{ matrix.package }} to ${{ env.LATEST_VERSION }}"
          body: |
            This PR automatically updates `${{ matrix.package }}` to version `${{ env.LATEST_VERSION }}`.
            
            Changes generated by GitHub Actions workflow.
          branch: "update-${{ matrix.package }}-${{ env.LATEST_VERSION }}"
          base: main

      - name: Enable Automerge
        if: env.UPDATE_DETECTED == 'true'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
          pull-request-number: ${{ env.PULL_REQUEST_NUMBER }}
          merge-method: "squash"
